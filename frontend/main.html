<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç§‘ç ”åŠ©æ‰‹ - ä¸»é¡µ</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f2027;
            --secondary: #203a43;
            --accent: #2c5364;
            --highlight: #00c9ff;
            --text: #e0e0e0;
            --success: #00ff9d;
            --warning: #ffcc00;
            --danger: #ff4d4d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            font-size: 16px;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(15, 32, 39, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0, 201, 255, 0.3);
        }
        
        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(to right, var(--highlight), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(0, 201, 255, 0.5);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--highlight), var(--success));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .logout-btn {
            background: linear-gradient(45deg, var(--danger), #ff0000);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 77, 77, 0.3);
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 77, 77, 0.5);
        }
        
        .main-layout {
            display: flex;
            gap: 30px;
            height: calc(100vh - 180px);
        }
        
        .document-panel {
            flex: 1;
            background: rgba(15, 32, 39, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 25px;
            border: 1px solid rgba(0, 201, 255, 0.2);
            overflow-y: auto;
            max-height: 100%;
        }
        
        .chat-panel {
            flex: 1.5;
            background: rgba(15, 32, 39, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 25px;
            border: 1px solid rgba(0, 201, 255, 0.2);
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 201, 255, 0.3);
        }
        
        .panel-header h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--highlight);
            font-size: 1.8em;
            margin: 0;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 201, 255, 0.3);
        }
        
        .upload-area {
            border: 2px dashed rgba(0, 201, 255, 0.5);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(44, 83, 100, 0.2);
        }
        
        .upload-area:hover {
            border-color: var(--highlight);
            background: rgba(0, 201, 255, 0.1);
            transform: translateY(-3px);
        }
        
        .upload-area i {
            font-size: 3em;
            color: var(--highlight);
            margin-bottom: 15px;
        }
        
        .upload-area h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .upload-area p {
            margin: 10px 0 0;
            color: #aaa;
        }
        
        .btn {
            background: linear-gradient(45deg, var(--highlight), #00ff9d);
            color: var(--primary);
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 201, 255, 0.3);
            margin: 8px 0;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 201, 255, 0.5);
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, var(--accent), var(--secondary));
            color: var(--text);
            box-shadow: 0 4px 15px rgba(44, 83, 100, 0.3);
        }
        
        .file-list {
            margin: 15px 0;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(44, 83, 100, 0.3);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid rgba(0, 201, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            background: rgba(15, 32, 39, 0.5);
            line-height: 1.6;
            min-height: 400px;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            animation: fadeIn 0.3s ease;
            line-height: 1.6;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(135deg, rgba(0, 201, 255, 0.2), rgba(0, 201, 255, 0.1));
            border: 1px solid rgba(0, 201, 255, 0.3);
            margin-left: 20%;
        }
        
        .ai-message {
            background: linear-gradient(135deg, rgba(44, 83, 100, 0.3), rgba(32, 58, 67, 0.3));
            border: 1px solid rgba(44, 83, 100, 0.5);
            margin-right: 20%;
        }
        
        .deep-analysis {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 201, 255, 0.15);
            border-radius: 10px;
            border-left: 4px solid var(--highlight);
        }
        
        .deep-analysis-header {
            font-weight: bold;
            color: var(--highlight);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .deep-analysis-content {
            line-height: 1.6;
        }

        /* ä¼˜åŒ– AI æ–‡æœ¬æ˜¾ç¤ºï¼šè‡ªåŠ¨æ¢è¡Œã€åˆ†ç‚¹æ›´æ¸…æ™°ã€ä»£ç å—æ ·å¼ */
        .answer-content {
            white-space: pre-wrap; /* ä¿ç•™ \n ä¸ºæ¢è¡Œ */
            line-height: 1.85;
        }
        .answer-content .ai-h2 {
            margin: 12px 0 8px;
            color: var(--highlight);
            font-weight: 700;
        }
        .answer-content ul.ai-list {
            margin: 6px 0 12px 20px;
        }
        .answer-content ul.ai-list li {
            margin: 4px 0;
        }
        .answer-content ol.ai-ol {
            margin: 6px 0 12px 22px;
            padding-left: 18px;
        }
        .answer-content ol.ai-ol li {
            margin: 4px 0;
        }
        .answer-content pre {
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 201, 255, 0.25);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            line-height: 1.6;
        }
        .answer-content code {
            color: #e6f3ff;
        }

        /* å›¾ç‰‡æ¸²æŸ“æ ·å¼ */
        .ai-image {
            margin: 10px 0;
            text-align: center;
        }
        .ai-image img {
            max-width: 100%;
            border-radius: 8px;
            border: 1px solid rgba(0, 201, 255, 0.2);
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        }
        
        .references-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 201, 255, 0.3);
        }
        
        .references-header {
            font-weight: bold;
            color: var(--success);
            margin-bottom: 10px;
        }
        
        .reference-item {
            margin: 8px 0;
            padding-left: 15px;
            border-left: 2px solid rgba(0, 255, 157, 0.3);
        }
        
        /* é‡ç‚¹å†…å®¹é«˜å…‰æ˜¾ç¤º */
        .highlight {
            background-color: rgba(0, 201, 255, 0.3);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .user-message .message-header {
            color: var(--highlight);
        }
        
        .ai-message .message-header {
            color: var(--success);
        }
        
        .input-section {
            margin-top: 15px;
        }
        
        .attachment-area {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .attachment-btn {
            background: rgba(44, 83, 100, 0.5);
            color: var(--text);
            border: 1px solid rgba(0, 201, 255, 0.3);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .attachment-btn:hover {
            background: rgba(0, 201, 255, 0.2);
        }
        
        .input-area {
            display: flex;
            gap: 10px;
        }
        
        .input-area input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid rgba(0, 201, 255, 0.3);
            border-radius: 30px;
            background: rgba(15, 32, 39, 0.7);
            color: var(--text);
            font-size: 1em;
        }
        
        .input-area input:focus {
            outline: none;
            border-color: var(--highlight);
            box-shadow: 0 0 10px rgba(0, 201, 255, 0.5);
        }
        
        .btn {
            background: linear-gradient(45deg, var(--highlight), #00ff9d);
            color: var(--primary);
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 201, 255, 0.3);
            margin: 0;
        }
        
        .knowledge-base {
            margin-top: 20px;
        }
        
        .literature-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        .literature-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(44, 83, 100, 0.3);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .literature-info {
            flex: 1;
        }
        
        .literature-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .literature-meta {
            font-size: 0.9em;
            color: #aaa;
        }
        
        .delete-btn {
            background: rgba(255, 77, 77, 0.2);
            color: var(--danger);
            border: 1px solid rgba(255, 77, 77, 0.5);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:hover {
            background: rgba(255, 77, 77, 0.3);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .status-offline {
            background: var(--danger);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 157, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0); }
        }
        
        .history-section {
            margin-top: 20px;
        }
        
        .history-section h3 {
            margin-bottom: 10px;
        }
        
        .history-list {
            max-height: 120px;
            overflow-y: auto;
        }
        
        /* éšè—æ–‡ä»¶è¾“å…¥å…ƒç´  */
        .hidden-file-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">AIç§‘ç ”åŠ©æ‰‹</div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span>æ¬¢è¿ï¼Œ<span id="username">ç”¨æˆ·</span></span>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
        
        <div class="main-layout">
            <!-- å·¦ä¾§æ–‡æ¡£ç®¡ç†åŒºåŸŸ -->
            <div class="document-panel">
                <div class="panel-header">
                    <h2>æ–‡æ¡£ç®¡ç†</h2>
                    <div>
                        <span class="status-indicator status-online pulse"></span>
                        <span>ç³»ç»Ÿè¿è¡Œä¸­</span>
                    </div>
                </div>
                
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <h3>ä¸Šä¼ PDFæ–‡çŒ®</h3>
                    <p>æ”¯æŒå¤šæ–‡ä»¶åŒæ—¶ä¸Šä¼ </p>
                    <p>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤åŒºåŸŸ</p>
                </div>
                
                <input type="file" id="fileInput" accept=".pdf" multiple class="hidden-file-input">
                
                <!-- CSV/MDæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-area" onclick="document.getElementById('dataFileInput').click()" style="margin-top: 15px;">
                    <h3>ä¸Šä¼ æ•°æ®æ–‡ä»¶ (CSV/MD)</h3>
                    <p>æ”¯æŒCSVå’ŒMarkdownæ ¼å¼</p>
                    <p>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤åŒºåŸŸ</p>
                </div>
                
                <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-area" onclick="document.getElementById('imageFileInput').click()" style="margin-top: 15px;">
                    <h3>ä¸Šä¼ å›¾ç‰‡</h3>
                    <p>æ”¯æŒJPGã€PNGã€GIFæ ¼å¼</p>
                    <p>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤åŒºåŸŸ</p>
                </div>
                
                <input type="file" id="dataFileInput" accept=".csv,.md" multiple class="hidden-file-input">
                <input type="file" id="imageFileInput" accept=".jpg,.jpeg,.png,.gif" multiple class="hidden-file-input">
                
                <div class="file-list" id="selectedFiles">
                    <p>æš‚æ— é€‰ä¸­æ–‡ä»¶</p>
                </div>
                
                <button class="btn" onclick="uploadDocuments()">ä¸Šä¼ å¹¶åˆ†æPDF</button>
                
                <!-- CSV/MDæ–‡ä»¶åˆ—è¡¨å’Œä¸Šä¼ æŒ‰é’® -->
                <div class="file-list" id="selectedDataFiles" style="margin-top: 15px;">
                    <p>æš‚æ— é€‰ä¸­æ•°æ®æ–‡ä»¶</p>
                </div>
                
                <button class="btn" onclick="uploadDataFiles()">ä¸Šä¼ å¹¶åˆ†ææ•°æ®æ–‡ä»¶</button>
                
                <!-- å›¾ç‰‡æ–‡ä»¶åˆ—è¡¨å’Œä¸Šä¼ æŒ‰é’® -->
                <div class="file-list" id="selectedImageFiles" style="margin-top: 15px;">
                    <p>æš‚æ— é€‰ä¸­å›¾ç‰‡</p>
                </div>
                
                <button class="btn" onclick="uploadImageFiles()">ä¸Šä¼ å¹¶åˆ†æå›¾ç‰‡</button>
                
                <div class="knowledge-base">
                    <h3>æ–‡çŒ®åº“ <span id="literatureCount">(0)</span></h3>
                    <div class="literature-list" id="knowledgeBase">
                        <p>æš‚æ— æ–‡çŒ®</p>
                    </div>
                </div>
                
                <!-- æ•°æ®æ–‡ä»¶åº“ -->
                <div class="knowledge-base" style="margin-top: 25px;">
                    <h3>æ•°æ®æ–‡ä»¶åº“ <span id="dataFileCount">(0)</span></h3>
                    <div class="literature-list" id="dataFileList">
                        <p>æš‚æ— æ•°æ®æ–‡ä»¶</p>
                    </div>
                </div>
                
                <!-- å›¾ç‰‡åº“ -->
                <div class="knowledge-base" style="margin-top: 25px;">
                    <h3>å›¾ç‰‡åº“ <span id="imageCount">(0)</span></h3>
                    <div class="literature-list" id="imageList">
                        <p>æš‚æ— å›¾ç‰‡</p>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§é—®ç­”åŒºåŸŸ -->
            <div class="chat-panel">
                <div class="panel-header">
                    <h2>AIé—®ç­”</h2>
                    <div>
                        <span class="status-indicator status-online"></span>
                        <span>AIå°±ç»ª</span>
                    </div>
                </div>
                
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <div class="message-header">
                            <span>AIåŠ©æ‰‹</span>
                            <span>ç°åœ¨</span>
                        </div>
                        <div>æ‚¨å¥½ï¼æˆ‘æ˜¯AIç§‘ç ”åŠ©æ‰‹ï¼ŒåŸºäºæ‚¨ä¸Šä¼ çš„æ–‡çŒ®èµ„æ–™ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„é—®ç­”æœåŠ¡ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ</div>
                    </div>
                </div>
                
                <div class="input-section">
                    <!-- é™„ä»¶ä¸Šä¼ åŒºåŸŸ -->
                    <div class="attachment-area">
                        <div class="attachment-btn" onclick="document.getElementById('attachImage').click()">
                            <span>ğŸ–¼ï¸ å›¾ç‰‡</span>
                        </div>
                        <div class="attachment-btn" onclick="document.getElementById('attachTable').click()">
                            <span>ğŸ“Š è¡¨æ ¼</span>
                        </div>
                        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                        <input type="file" id="attachImage" accept=".jpg,.jpeg,.png,.gif" class="hidden-file-input">
                        <input type="file" id="attachTable" accept=".csv,.xlsx" class="hidden-file-input">
                    </div>
                    
                    <div class="input-area">
                        <input type="text" id="questionInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...">
                        <button class="btn" onclick="askQuestion()">å‘é€</button>
                    </div>
                </div>
                
                <div class="history-section">
                    <h3>å†å²é—®ç­”</h3>
                    <div class="history-list" id="historyList">
                        <p>æš‚æ— å†å²è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let selectedFiles = [];
        let selectedDataFiles = [];
        let selectedImageFiles = [];
        let chatHistory = [];
        let literatureList = [];
        let dataFileList = [];
        let imageList = [];
        let attachedImages = [];
        let attachedTables = [];
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            const token = localStorage.getItem('token');
            if (!token) {
                // æ²¡æœ‰tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = '/';
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·å
            const username = 'testuser';
            document.getElementById('username').textContent = username;
            document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
            
            // åŠ è½½æ–‡çŒ®åº“
            loadKnowledgeBase();
            
            // åŠ è½½æ•°æ®æ–‡ä»¶åº“
            loadDataFiles();
            
            // åŠ è½½å›¾ç‰‡åº“
            loadImages();
            
            // åŠ è½½å†å²é—®ç­”
            loadChatHistory();
            
            // ä¸ºé™„ä»¶ä¸Šä¼ æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('attachImage').addEventListener('change', function(e) {
                handleAttachedImage(e.target.files[0]);
            });
            
            document.getElementById('attachTable').addEventListener('change', function(e) {
                handleAttachedTable(e.target.files[0]);
            });
        };
        
        // å¤„ç†é™„åŠ å›¾ç‰‡
        function handleAttachedImage(file) {
            if (!file || !file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            attachedImages.push(file);
            alert(`å·²é™„åŠ å›¾ç‰‡: ${file.name}`);
        }
        
        // å¤„ç†é™„åŠ è¡¨æ ¼
        function handleAttachedTable(file) {
            if (!file) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„è¡¨æ ¼æ–‡ä»¶');
                return;
            }
            
            attachedTables.push(file);
            alert(`å·²é™„åŠ è¡¨æ ¼: ${file.name}`);
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
        
        // PDFæ–‡ä»¶é€‰æ‹©äº‹ä»¶
        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            updateSelectedFilesList();
        });
        
        // CSV/MDæ–‡ä»¶é€‰æ‹©äº‹ä»¶
        document.getElementById('dataFileInput').addEventListener('change', function(e) {
            selectedDataFiles = Array.from(e.target.files);
            updateSelectedDataFilesList();
        });
        
        // å›¾ç‰‡æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        document.getElementById('imageFileInput').addEventListener('change', function(e) {
            selectedImageFiles = Array.from(e.target.files);
            updateSelectedImageFilesList();
        });
        
        // æ›´æ–°é€‰ä¸­PDFæ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateSelectedFilesList() {
            const fileListDiv = document.getElementById('selectedFiles');
            
            if (selectedFiles.length === 0) {
                fileListDiv.innerHTML = '<p>æš‚æ— é€‰ä¸­æ–‡ä»¶</p>';
                return;
            }
            
            let html = '';
            selectedFiles.forEach((file, index) => {
                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <div>${file.name}</div>
                            <div style="font-size: 0.9em; color: #aaa;">${(file.size/1024).toFixed(2)} KB</div>
                        </div>
                        <button class="delete-btn" onclick="removeFile(${index})">âœ•</button>
                    </div>
                `;
            });
            
            fileListDiv.innerHTML = html;
        }
        
        // æ›´æ–°é€‰ä¸­æ•°æ®æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateSelectedDataFilesList() {
            const fileListDiv = document.getElementById('selectedDataFiles');
            
            if (selectedDataFiles.length === 0) {
                fileListDiv.innerHTML = '<p>æš‚æ— é€‰ä¸­æ•°æ®æ–‡ä»¶</p>';
                return;
            }
            
            let html = '';
            selectedDataFiles.forEach((file, index) => {
                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <div>${file.name}</div>
                            <div style="font-size: 0.9em; color: #aaa;">${(file.size/1024).toFixed(2)} KB</div>
                        </div>
                        <button class="delete-btn" onclick="removeDataFile(${index})">âœ•</button>
                    </div>
                `;
            });
            
            fileListDiv.innerHTML = html;
        }
        
        // æ›´æ–°é€‰ä¸­å›¾ç‰‡æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateSelectedImageFilesList() {
            const fileListDiv = document.getElementById('selectedImageFiles');
            
            if (selectedImageFiles.length === 0) {
                fileListDiv.innerHTML = '<p>æš‚æ— é€‰ä¸­å›¾ç‰‡</p>';
                return;
            }
            
            let html = '';
            selectedImageFiles.forEach((file, index) => {
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºå›¾ç‰‡æ ¼å¼
                if (file.type.startsWith('image/')) {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div>${file.name}</div>
                                <div style="font-size: 0.9em; color: #aaa;">${(file.size/1024).toFixed(2)} KB</div>
                            </div>
                            <button class="delete-btn" onclick="removeImageFile(${index})">âœ•</button>
                        </div>
                    `;
                }
            });
            
            fileListDiv.innerHTML = html;
        }
        
        // ç§»é™¤é€‰ä¸­PDFæ–‡ä»¶
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateSelectedFilesList();
        }
        
        // ç§»é™¤é€‰ä¸­æ•°æ®æ–‡ä»¶
        function removeDataFile(index) {
            selectedDataFiles.splice(index, 1);
            updateSelectedDataFilesList();
        }
        
        // ç§»é™¤é€‰ä¸­å›¾ç‰‡æ–‡ä»¶
        function removeImageFile(index) {
            selectedImageFiles.splice(index, 1);
            updateSelectedImageFilesList();
        }
        
        // ä¸Šä¼ PDFæ–‡æ¡£
        function uploadDocuments() {
            if (selectedFiles.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªPDFæ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            for (let file of selectedFiles) {
                if (file.type !== 'application/pdf') {
                    alert(`æ–‡ä»¶ "${file.name}" ä¸æ˜¯PDFæ ¼å¼`);
                    return;
                }
            }
            
            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('pdf', file);
            });
            
            // è·å–token
            const token = localStorage.getItem('token');
            
            // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            const uploadButton = document.querySelector('.btn');
            const originalText = uploadButton.textContent;
            uploadButton.textContent = 'ä¸Šä¼ ä¸­...';
            uploadButton.disabled = true;
            
            // å‘é€ä¸Šä¼ è¯·æ±‚
            fetch('/api/pdf/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    // æ¸…ç©ºé€‰ä¸­æ–‡ä»¶
                    selectedFiles = [];
                    updateSelectedFilesList();
                    // é‡æ–°åŠ è½½çŸ¥è¯†åº“
                    loadKnowledgeBase();
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                alert('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                uploadButton.textContent = originalText;
                uploadButton.disabled = false;
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                document.getElementById('fileInput').value = '';
            });
        }
        
        // ä¸Šä¼ æ•°æ®æ–‡ä»¶
        function uploadDataFiles() {
            if (selectedDataFiles.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ•°æ®æ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            for (let file of selectedDataFiles) {
                if (file.type !== 'text/csv' && !file.name.endsWith('.csv') && !file.name.endsWith('.md')) {
                    alert(`æ–‡ä»¶ "${file.name}" ä¸æ˜¯CSVæˆ–Markdownæ ¼å¼`);
                    return;
                }
            }
            
            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            selectedDataFiles.forEach(file => {
                formData.append('datafile', file);
            });
            
            // è·å–token
            const token = localStorage.getItem('token');
            
            // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            const uploadButtons = document.querySelectorAll('.btn');
            const uploadDataButton = uploadButtons[1]; // ç¬¬äºŒä¸ªæŒ‰é’®æ˜¯ä¸Šä¼ æ•°æ®æ–‡ä»¶çš„æŒ‰é’®
            const originalText = uploadDataButton.textContent;
            uploadDataButton.textContent = 'ä¸Šä¼ ä¸­...';
            uploadDataButton.disabled = true;
            
            // å‘é€ä¸Šä¼ è¯·æ±‚
            fetch('/api/data/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    // æ¸…ç©ºé€‰ä¸­æ–‡ä»¶
                    selectedDataFiles = [];
                    updateSelectedDataFilesList();
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                alert('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                uploadDataButton.textContent = originalText;
                uploadDataButton.disabled = false;
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                document.getElementById('dataFileInput').value = '';
            });
        }
        
        // ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
        function uploadImageFiles() {
            if (selectedImageFiles.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            for (let file of selectedImageFiles) {
                if (!file.type.startsWith('image/')) {
                    alert(`æ–‡ä»¶ "${file.name}" ä¸æ˜¯å›¾ç‰‡æ ¼å¼`);
                    return;
                }
            }
            
            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            selectedImageFiles.forEach(file => {
                formData.append('image', file);
            });
            
            // è·å–token
            const token = localStorage.getItem('token');
            
            // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            const uploadButtons = document.querySelectorAll('.btn');
            const uploadImageButton = uploadButtons[2]; // ç¬¬ä¸‰ä¸ªæŒ‰é’®æ˜¯ä¸Šä¼ å›¾ç‰‡çš„æŒ‰é’®
            const originalText = uploadImageButton.textContent;
            uploadImageButton.textContent = 'ä¸Šä¼ ä¸­...';
            uploadImageButton.disabled = true;
            
            // å‘é€ä¸Šä¼ è¯·æ±‚
            fetch('/api/image/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    // æ¸…ç©ºé€‰ä¸­æ–‡ä»¶
                    selectedImageFiles = [];
                    updateSelectedImageFilesList();
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                alert('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                uploadImageButton.textContent = originalText;
                uploadImageButton.disabled = false;
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                document.getElementById('imageFileInput').value = '';
            });
        }
        
        // åŠ è½½æ–‡çŒ®åº“
        function loadKnowledgeBase() {
            const token = localStorage.getItem('token');
            
            fetch('/api/knowledge/literatures', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                literatureList = data;
                const knowledgeBaseDiv = document.getElementById('knowledgeBase');
                const literatureCountSpan = document.getElementById('literatureCount');
                
                literatureCountSpan.textContent = `(${data.length})`;
                
                if (data.length > 0) {
                    let html = '';
                    data.forEach(literature => {
                        html += `
                            <div class="literature-item">
                                <div class="literature-info">
                                    <div class="literature-name">${literature.fileName}</div>
                                    <div class="literature-meta">${new Date(literature.modified).toLocaleString()} â€¢ ${(literature.size/1024).toFixed(2)} KB</div>
                                </div>
                                <button class="delete-btn" onclick="deleteLiterature('${literature.fileName}')">âœ•</button>
                            </div>
                        `;
                    });
                    knowledgeBaseDiv.innerHTML = html;
                } else {
                    knowledgeBaseDiv.innerHTML = '<p>æš‚æ— æ–‡çŒ®</p>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½æ–‡çŒ®åº“æ—¶å‡ºé”™:', error);
                document.getElementById('knowledgeBase').innerHTML = '<p>åŠ è½½æ–‡çŒ®åº“å¤±è´¥</p>';
            });
        }
        
        // åŠ è½½æ•°æ®æ–‡ä»¶åº“
        function loadDataFiles() {
            const token = localStorage.getItem('token');
            
            fetch('/api/data/files', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                dataFileList = data;
                const dataFileListDiv = document.getElementById('dataFileList');
                const dataFileCountSpan = document.getElementById('dataFileCount');
                
                dataFileCountSpan.textContent = `(${data.length})`;
                
                if (data.length > 0) {
                    let html = '';
                    data.forEach(file => {
                        html += `
                            <div class="literature-item">
                                <div class="literature-info">
                                    <div class="literature-name">${file.fileName}</div>
                                    <div class="literature-meta">${new Date(file.modified).toLocaleString()} â€¢ ${(file.size/1024).toFixed(2)} KB</div>
                                </div>
                                <button class="delete-btn" onclick="deleteDataFile('${file.fileName}')">âœ•</button>
                            </div>
                        `;
                    });
                    dataFileListDiv.innerHTML = html;
                } else {
                    dataFileListDiv.innerHTML = '<p>æš‚æ— æ•°æ®æ–‡ä»¶</p>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½æ•°æ®æ–‡ä»¶åº“æ—¶å‡ºé”™:', error);
                document.getElementById('dataFileList').innerHTML = '<p>åŠ è½½æ•°æ®æ–‡ä»¶åº“å¤±è´¥</p>';
            });
        }
        
        // åŠ è½½å›¾ç‰‡åº“
        function loadImages() {
            const token = localStorage.getItem('token');
            
            fetch('/api/image/list', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                imageList = data;
                const imageListDiv = document.getElementById('imageList');
                const imageCountSpan = document.getElementById('imageCount');
                
                imageCountSpan.textContent = `(${data.length})`;
                
                if (data.length > 0) {
                    let html = '';
                    data.forEach(file => {
                        html += `
                            <div class="literature-item">
                                <div class="literature-info">
                                    <div class="literature-name">${file.fileName}</div>
                                    <div class="literature-meta">${new Date(file.modified).toLocaleString()} â€¢ ${(file.size/1024).toFixed(2)} KB</div>
                                </div>
                                <button class="delete-btn" onclick="deleteImage('${file.fileName}')">âœ•</button>
                            </div>
                        `;
                    });
                    imageListDiv.innerHTML = html;
                } else {
                    imageListDiv.innerHTML = '<p>æš‚æ— å›¾ç‰‡</p>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½å›¾ç‰‡åº“æ—¶å‡ºé”™:', error);
                document.getElementById('imageList').innerHTML = '<p>åŠ è½½å›¾ç‰‡åº“å¤±è´¥</p>';
            });
        }
        
        // åˆ é™¤æ–‡çŒ®
        function deleteLiterature(fileName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡çŒ® "${fileName}" å—ï¼Ÿ`)) {
                return;
            }
            
            const token = localStorage.getItem('token');
            
            fetch(`/api/knowledge/literatures/${fileName}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    // é‡æ–°åŠ è½½æ–‡çŒ®åº“
                    loadKnowledgeBase();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤æ–‡çŒ®æ—¶å‡ºé”™:', error);
                alert('åˆ é™¤æ–‡çŒ®è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
            });
        }
        
        // åˆ é™¤æ•°æ®æ–‡ä»¶
        function deleteDataFile(fileName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ•°æ®æ–‡ä»¶ "${fileName}" å—ï¼Ÿ`)) {
                return;
            }
            
            const token = localStorage.getItem('token');
            
            fetch(`/api/data/files/${fileName}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    // é‡æ–°åŠ è½½æ•°æ®æ–‡ä»¶åº“
                    loadDataFiles();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤æ•°æ®æ–‡ä»¶æ—¶å‡ºé”™:', error);
                alert('åˆ é™¤æ•°æ®æ–‡ä»¶è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
            });
        }
        
        // åˆ é™¤å›¾ç‰‡
        function deleteImage(fileName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å›¾ç‰‡ "${fileName}" å—ï¼Ÿ`)) {
                return;
            }
            
            const token = localStorage.getItem('token');
            
            fetch(`/api/image/delete/${fileName}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    // é‡æ–°åŠ è½½å›¾ç‰‡åº“
                    loadImages();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å›¾ç‰‡æ—¶å‡ºé”™:', error);
                alert('åˆ é™¤å›¾ç‰‡è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
            });
        }
        
        // æé—®
        function askQuestion() {
            const question = document.getElementById('questionInput').value;
            if (!question.trim()) return;
            
            // æ˜¾ç¤ºç”¨æˆ·é—®é¢˜
            const chatContainer = document.getElementById('chatContainer');
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.innerHTML = `
                <div class="message-header">
                    <span>æ‚¨</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                </div>
                <div>${question}</div>
            `;
            chatContainer.appendChild(userMessage);
            
            // å¦‚æœæœ‰é™„åŠ çš„å›¾ç‰‡æˆ–è¡¨æ ¼ï¼Œåœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­æ˜¾ç¤º
            if (attachedImages.length > 0 || attachedTables.length > 0) {
                let attachmentInfo = '<div style="margin-top: 10px; font-size: 0.9em;">é™„åŠ å†…å®¹: ';
                if (attachedImages.length > 0) {
                    attachmentInfo += `å›¾ç‰‡(${attachedImages.length}ä¸ª) `;
                }
                if (attachedTables.length > 0) {
                    attachmentInfo += `è¡¨æ ¼(${attachedTables.length}ä¸ª)`;
                }
                attachmentInfo += '</div>';
                userMessage.innerHTML += attachmentInfo;
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('questionInput').value = '';
            
            // æ˜¾ç¤º"AIæ­£åœ¨æ€è€ƒ"æç¤º
            const thinkingMessage = document.createElement('div');
            thinkingMessage.className = 'message ai-message';
            thinkingMessage.id = 'thinkingMessage';
            thinkingMessage.innerHTML = `
                <div class="message-header">
                    <span>AIåŠ©æ‰‹</span>
                    <span>ç°åœ¨</span>
                </div>
                <div>æ­£åœ¨æ·±åº¦åˆ†ææ‚¨çš„é—®é¢˜...</div>
            `;
            chatContainer.appendChild(thinkingMessage);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // è·å–token
            const token = localStorage.getItem('token');
            
            // å‡†å¤‡è¯·æ±‚æ•°æ®
            const requestData = {
                question: question
            };
            
            // å¦‚æœæœ‰é™„åŠ å†…å®¹ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¤„ç†é€»è¾‘
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦ä¸Šä¼ é™„ä»¶
            
            // å‘é€é—®é¢˜åˆ°åç«¯
            fetch('/api/qa/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // ç§»é™¤"æ­£åœ¨æ€è€ƒ"æç¤º
                document.getElementById('thinkingMessage').remove();
                
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai-message';
                aiMessage.innerHTML = `
                    <div class="message-header">
                        <span>AIåŠ©æ‰‹</span>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="answer-content"></div>
                `;
                
                chatContainer.appendChild(aiMessage);
                
                // è·å–å›ç­”å†…å®¹å®¹å™¨
                const answerContent = aiMessage.querySelector('.answer-content');
                
                // å¤„ç†AIå›ç­”ï¼šMarkdown/åˆ—è¡¨/ä»£ç /å›¾ç‰‡æ¸²æŸ“ + è¡¨æƒ…/é«˜äº®
                const answerText = data.answer || 'æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç­”æ¡ˆã€‚';
                const renderedAnswer = renderAIContent(answerText);
                
                // å®æ—¶é€å­—è¾“å‡ºå›ç­”ï¼ˆä¿ç•™HTMLæ ‡ç­¾ï¼‰
                typeWriterEffect(answerContent, renderedAnswer, () => {
                    // æ·»åŠ æ·±åº¦åˆ†æéƒ¨åˆ†
                    if (data.analysis) {
                        const deepAnalysis = document.createElement('div');
                        deepAnalysis.className = 'deep-analysis';
                        deepAnalysis.innerHTML = `
                            <div class="deep-analysis-header">
                                <span>ğŸ”¬ æ·±åº¦åˆ†æ</span>
                            </div>
                            <div class="deep-analysis-content"></div>
                        `;
                        aiMessage.appendChild(deepAnalysis);
                        
                        const analysisContent = deepAnalysis.querySelector('.deep-analysis-content');
                        typeWriterEffect(analysisContent, renderAIContent(data.analysis || ''), () => {
                            // æ·»åŠ ä»£ç è§£å†³æ–¹æ¡ˆéƒ¨åˆ†ï¼ˆå¦‚æœæœ‰ï¼‰
                            if (data.code) {
                                const codeSolution = document.createElement('div');
                                codeSolution.className = 'deep-analysis';
                                codeSolution.innerHTML = `
                                    <div class="deep-analysis-header">
                                        <span>ğŸ’» ä»£ç è§£å†³æ–¹æ¡ˆ</span>
                                    </div>
                                    <div class="deep-analysis-content"></div>
                                `;
                                aiMessage.appendChild(codeSolution);
                                
                                const codeContent = codeSolution.querySelector('.deep-analysis-content');
                                typeWriterEffect(codeContent, renderAIContent(data.code || ''), () => {
                                    // å¦‚æœæœ‰å‚è€ƒæ–‡çŒ®ï¼Œæ·»åŠ åˆ°å›ç­”ä¸­
                                    if (data.references && data.references.length > 0) {
                                        let referencesHTML = `
                                            <div class="references-section">
                                                <div class="references-header">å‚è€ƒæ–‡çŒ®</div>
                                        `;
                                        
                                        data.references.forEach(ref => {
                                            referencesHTML += `<div class="reference-item">${ref}</div>`;
                                        });
                                        
                                        referencesHTML += `</div>`;
                                        
                                        const referencesDiv = document.createElement('div');
                                        referencesDiv.innerHTML = referencesHTML;
                                        aiMessage.appendChild(referencesDiv);
                                        
                                        // æ»šåŠ¨åˆ°åº•éƒ¨
                                        chatContainer.scrollTop = chatContainer.scrollHeight;
                                    }
                                });
                            } else if (data.references && data.references.length > 0) {
                                // å¦‚æœæ²¡æœ‰ä»£ç è§£å†³æ–¹æ¡ˆä½†æœ‰å‚è€ƒæ–‡çŒ®
                                let referencesHTML = `
                                    <div class="references-section">
                                        <div class="references-header">å‚è€ƒæ–‡çŒ®</div>
                                `;
                                
                                data.references.forEach(ref => {
                                    referencesHTML += `<div class="reference-item">${ref}</div>`;
                                });
                                
                                referencesHTML += `</div>`;
                                
                                const referencesDiv = document.createElement('div');
                                referencesDiv.innerHTML = referencesHTML;
                                aiMessage.appendChild(referencesDiv);
                                
                                // æ»šåŠ¨åˆ°åº•éƒ¨
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                        });
                    } else if (data.code) {
                        // å¦‚æœæ²¡æœ‰æ·±åº¦åˆ†æä½†æœ‰ä»£ç è§£å†³æ–¹æ¡ˆ
                        const codeSolution = document.createElement('div');
                        codeSolution.className = 'deep-analysis';
                        codeSolution.innerHTML = `
                            <div class="deep-analysis-header">
                                <span>ğŸ’» ä»£ç è§£å†³æ–¹æ¡ˆ</span>
                            </div>
                            <div class="deep-analysis-content"></div>
                        `;
                        aiMessage.appendChild(codeSolution);
                        
                        const codeContent = codeSolution.querySelector('.deep-analysis-content');
                        typeWriterEffect(codeContent, data.code, () => {
                            // å¦‚æœæœ‰å‚è€ƒæ–‡çŒ®ï¼Œæ·»åŠ åˆ°å›ç­”ä¸­
                            if (data.references && data.references.length > 0) {
                                let referencesHTML = `
                                    <div class="references-section">
                                        <div class="references-header">å‚è€ƒæ–‡çŒ®</div>
                                `;
                                
                                data.references.forEach(ref => {
                                    referencesHTML += `<div class="reference-item">${ref}</div>`;
                                });
                                
                                referencesHTML += `</div>`;
                                
                                const referencesDiv = document.createElement('div');
                                referencesDiv.innerHTML = referencesHTML;
                                aiMessage.appendChild(referencesDiv);
                                
                                // æ»šåŠ¨åˆ°åº•éƒ¨
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                        });
                    } else if (data.references && data.references.length > 0) {
                        // å¦‚æœæ²¡æœ‰æ·±åº¦åˆ†æå’Œä»£ç è§£å†³æ–¹æ¡ˆä½†æœ‰å‚è€ƒæ–‡çŒ®
                        let referencesHTML = `
                            <div class="references-section">
                                <div class="references-header">å‚è€ƒæ–‡çŒ®</div>
                        `;
                        
                        data.references.forEach(ref => {
                            referencesHTML += `<div class="reference-item">${ref}</div>`;
                        });
                        
                        referencesHTML += `</div>`;
                        
                        const referencesDiv = document.createElement('div');
                        referencesDiv.innerHTML = referencesHTML;
                        aiMessage.appendChild(referencesDiv);
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                    
                    // é‡æ–°åŠ è½½å†å²è®°å½•
                    loadChatHistory();
                });
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // æ¸…ç©ºé™„ä»¶
                attachedImages = [];
                attachedTables = [];
            })
            .catch(error => {
                console.error('é—®ç­”é”™è¯¯:', error);
                // ç§»é™¤"æ­£åœ¨æ€è€ƒ"æç¤º
                const thinkingMessage = document.getElementById('thinkingMessage');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message ai-message';
                errorMessage.innerHTML = `
                    <div class="message-header">
                        <span>AIåŠ©æ‰‹</span>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div>æŠ±æ­‰ï¼Œå›ç­”é—®é¢˜æ—¶å‡ºç°é”™è¯¯: ${error.message}</div>
                `;
                chatContainer.appendChild(errorMessage);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // æ¸…ç©ºé™„ä»¶
                attachedImages = [];
                attachedTables = [];
            });
        }
        
        // åŠ è½½èŠå¤©å†å²
        function loadChatHistory() {
            const token = localStorage.getItem('token');
            
            fetch('/api/qa/history', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                chatHistory = data;
                const historyListDiv = document.getElementById('historyList');
                
                if (data.length > 0) {
                    let html = '';
                    // åªæ˜¾ç¤ºæœ€è¿‘5æ¡è®°å½•
                    const recentHistory = data.slice(-5);
                    recentHistory.forEach(item => {
                        html += `
                            <div style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div style="font-size: 0.9em; color: #aaa;">${new Date(item.timestamp).toLocaleString()}</div>
                                <div style="margin-top: 5px;">${item.question.substring(0, 30)}${item.question.length > 30 ? '...' : ''}</div>
                            </div>
                        `;
                    });
                    historyListDiv.innerHTML = html;
                } else {
                    historyListDiv.innerHTML = '<p>æš‚æ— å†å²è®°å½•</p>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½é—®ç­”å†å²æ—¶å‡ºé”™:', error);
                // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
                const savedHistory = localStorage.getItem('chatHistory');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                }
                
                const historyListDiv = document.getElementById('historyList');
                if (chatHistory.length > 0) {
                    let html = '';
                    // åªæ˜¾ç¤ºæœ€è¿‘5æ¡è®°å½•
                    const recentHistory = chatHistory.slice(-5);
                    recentHistory.forEach(item => {
                        html += `
                            <div style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div style="font-size: 0.9em; color: #aaa;">${new Date(item.timestamp).toLocaleString()}</div>
                                <div style="margin-top: 5px;">${item.question.substring(0, 30)}${item.question.length > 30 ? '...' : ''}</div>
                            </div>
                        `;
                    });
                    historyListDiv.innerHTML = html;
                } else {
                    historyListDiv.innerHTML = '<p>æš‚æ— å†å²è®°å½•</p>';
                }
            });
        }
        
        // å›è½¦å‘é€é—®é¢˜
        document.getElementById('questionInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askQuestion();
            }
        });
        
        // æ‰“å­—æœºæ•ˆæœå‡½æ•°ï¼ˆæ”¯æŒHTMLæ ‡ç­¾ï¼‰
        function typeWriterEffect(element, htmlText, callback) {
            let processedText = htmlText || '';
            let i = 0;
            const speed = 20; // æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’ï¼‰
            
            function type() {
                if (i < processedText.length) {
                    let char = processedText.charAt(i);
                    
                    if (char === '<') {
                        const tagEnd = processedText.indexOf('>', i);
                        if (tagEnd !== -1) {
                            const tag = processedText.substring(i, tagEnd + 1);
                            element.innerHTML += tag;
                            i = tagEnd + 1;
                        } else {
                            element.innerHTML += char;
                            i++;
                        }
                    } else {
                        element.innerHTML += char;
                        i++;
                    }
                    
                    setTimeout(type, speed);
                } else {
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                }
            }
            
            type();
        }

        // è½»é‡å†…å®¹æ¸²æŸ“ï¼šæ ‡é¢˜/åˆ—è¡¨/ä»£ç /è¡Œå†…ä»£ç /ç²—ä½“/å›¾ç‰‡/æ¢è¡Œ
        function renderAIContent(text) {
            if (!text) return '';
            
            // è¡¨æƒ…ä»£ç æ›¿æ¢
            const emojiMap = {
                ':smile:': 'ğŸ˜Š', ':thumbsup:': 'ğŸ‘', ':star:': 'ğŸŒŸ', ':check:': 'âœ…', ':x:': 'âŒ',
                ':question:': 'â“', ':warning:': 'âš ï¸', ':microscope:': 'ğŸ”¬', ':chart:': 'ğŸ“Š',
                ':lightbulb:': 'ğŸ’¡', ':handshake:': 'ğŸ¤', ':pray:': 'ğŸ™'
            };
            for (const [code, emoji] of Object.entries(emojiMap)) {
                text = text.replace(new RegExp(code, 'g'), emoji);
            }
            
            // ä»£ç å— ```...```
            text = text.replace(/```([\s\S]*?)```/g, function(_, code) {
                const escaped = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<pre><code>${escaped}</code></pre>`;
            });
            
            // è¡Œå†…ä»£ç  `code`
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // ç²—ä½“ **text**
            text = text.replace(/\*\*(.*?)\*\*/g, '<span class="highlight">$1</span>');
            
            // å›¾ç‰‡ ![alt](url)
            text = text.replace(/!\[(.*?)\]\((.*?)\)/g, '<div class="ai-image"><img alt="$1" src="$2" /></div>');
            
            // æ ‡é¢˜/åˆ—è¡¨/æ®µè½
            const lines = text.split(/\r?\n/);
            const out = [];
            let listBuffer = [];
            let olistBuffer = [];
            
            function flushList() {
                if (listBuffer.length > 0) {
                    out.push('<ul class="ai-list">' + listBuffer.map(li => `<li>${li}</li>`).join('') + '</ul>');
                    listBuffer = [];
                }
                if (olistBuffer.length > 0) {
                    out.push('<ol class="ai-ol">' + olistBuffer.map(li => `<li>${li}</li>`).join('') + '</ol>');
                    olistBuffer = [];
                }
            }
            
            for (let line of lines) {
                const trimmed = line.trim();
                if (!trimmed) { flushList(); out.push(''); continue; }
                if (/^###\s+/.test(trimmed)) { flushList(); out.push(`<div class=\"ai-h2\">${trimmed.replace(/^###\s+/, '')}</div>`); continue; }
                if (/^##\s+/.test(trimmed)) { flushList(); out.push(`<div class=\"ai-h2\">${trimmed.replace(/^##\s+/, '')}</div>`); continue; }
                // æ— åºåˆ—è¡¨
                if (/^[-*]\s+/.test(trimmed)) { listBuffer.push(trimmed.replace(/^[-*]\s+/, '')); continue; }
                // æœ‰åºåˆ—è¡¨ï¼ˆ1. / 1) / 1ã€ / 1.1. / 1.1ï¼‰
                if (/^\d+[\.|\)|ã€]\s+/.test(trimmed) || /^\d+\.\d+([\.|\)]?)\s+/.test(trimmed)) {
                    const item = trimmed.replace(/^((\d+\.\d+)|(\d+))[\.|\)|ã€]?\s+/, '');
                    olistBuffer.push(item);
                    continue;
                }
                flushList();
                out.push(trimmed);
            }
            flushList();
            return out.join('\n');
        }
    </script>
</body>
</html>