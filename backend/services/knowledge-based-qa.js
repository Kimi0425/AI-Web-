// 基于知识库的问答系统\nconst DashScopeAPI = require('../services/dashscope-api');\nconst KnowledgeBaseManager = require('../services/knowledge-base-manager');\nconst path = require('path');\n\nclass KnowledgeBasedQA {\n  constructor() {\n    this.dashscopeAPI = new DashScopeAPI(process.env.DASHSCOPE_API_KEY);\n    this.knowledgeBaseManager = new KnowledgeBaseManager(\n      path.join(__dirname, '../../knowledge_base')\n    );\n  }\n  \n  // 基于知识库回答问题\n  async answerQuestion(userId, question) {\n    try {\n      // 获取用户知识库中的所有文献\n      const literatures = this.knowledgeBaseManager.getUserLiteratures(userId);\n      \n      if (literatures.length === 0) {\n        return { answer: \"您的知识库中还没有文献，请先上传PDF文献。\", references: [] };\n      }\n      \n      // 收集所有文献内容作为上下文\n      let knowledgeBaseContent = \"\";\n      const references = [];\n      \n      for (const literature of literatures) {\n        const content = this.knowledgeBaseManager.getLiteratureContent(userId, literature.fileName);\n        if (content) {\n          knowledgeBaseContent += `\\n\\n文献: ${literature.fileName}\\n内容: ${content}`;\n          references.push(literature.fileName);\n        }\n      }\n      \n      // 调用通义大模型API进行问答\n      const response = await this.dashscopeAPI.answerWithKnowledgeBase(question, knowledgeBaseContent);\n      \n      // 提取答案和引用文献\n      const answer = response.output.text || \"抱歉，无法生成答案。\";\n      \n      return { answer: answer, references: references };\n    } catch (error) {\n      console.error('问答过程中出错:', error);\n      throw error;\n    }\n  }\n  \n  // 根据特定文献回答问题\n  async answerQuestionWithSpecificLiterature(userId, question, literatureName) {\n    try {\n      // 获取特定文献内容\n      const literatureContent = this.knowledgeBaseManager.getLiteratureContent(userId, literatureName);\n      \n      if (!literatureContent) {\n        return { answer: \"指定的文献不存在。\", references: [] };\n      }\n      \n      // 构建带文献内容的提示\n      const knowledgeBaseContent = `文献: ${literatureName}\\n内容: ${literatureContent}`;\n      \n      // 调用通义大模型API进行问答\n      const response = await this.dashscopeAPI.answerWithKnowledgeBase(question, knowledgeBaseContent);\n      \n      // 提取答案和引用文献\n      const answer = response.output.text || \"抱歉，无法生成答案。\";\n      \n      return { answer: answer, references: [literatureName] };\n    } catch (error) {\n      console.error('问答过程中出错:', error);\n      throw error;\n    }\n  }\n}\n\nmodule.exports = KnowledgeBasedQA;