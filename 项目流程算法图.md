# AI_WEB 项目流程算法图

## 🏗️ 系统整体架构流程

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面层     │    │   后端服务层     │    │   数据存储层     │
│  (Frontend)     │    │   (Backend)     │    │   (Storage)     │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • login.html    │    │ • Express.js    │    │ • MongoDB       │
│ • main.html     │◄──►│ • JWT认证       │◄──►│ • 文件系统      │
│ • 响应式UI      │    │ • API路由       │    │ • 知识库存储    │
│ • 实时交互      │    │ • 中间件        │    │ • 向量数据库    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## 🔐 用户认证流程

```
开始
  │
  ▼
┌─────────────────┐
│   用户登录页面   │
│  (login.html)   │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 输入用户名密码   │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ POST /api/auth/ │
│     login       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 验证用户存在性   │
│ User.findOne()  │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ bcrypt密码验证   │
│ compare()       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 生成JWT Token   │
│ jwt.sign()      │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 返回Token到前端  │
│ localStorage    │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 跳转到主页面     │
│ (main.html)     │
└─────────────────┘
```

---

## 📄 PDF文档处理流程

```
开始
  │
  ▼
┌─────────────────┐
│ 选择PDF文件     │
│ (多文件支持)     │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 文件类型验证     │
│ application/pdf │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ Multer文件上传   │
│ /api/pdf/upload │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ PDFProcessor    │
│ 文本提取处理     │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ PDF.js解析      │
│ 逐页提取文本     │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 保存到知识库     │
│ knowledge_base/ │
│ {userId}/       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 返回处理结果     │
│ 成功/失败状态    │
└─────────────────┘
```

---

## 🤖 AI问答处理流程

```
开始
  │
  ▼
┌─────────────────┐
│ 用户输入问题     │
│ (main.html)     │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ POST /api/qa/   │
│     ask         │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 获取用户知识库   │
│ KnowledgeBase   │
│ Manager         │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 构建知识库内容   │
│ 文献内容拼接     │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 多模型融合调用   │
│ QwenAPI         │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 1. 深度思考模型  │
│ 问题分析        │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 2. 主回答模型    │
│ 基于知识库回答   │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 3. 代码生成模型  │
│ (如需要)        │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 提取引用文献     │
│ extractReferences│
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 保存问答记录     │
│ qa_history.json │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 返回结构化回答   │
│ answer/analysis/│
│ code/references │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 前端渲染展示     │
│ 打字机效果      │
│ Markdown渲染    │
└─────────────────┘
```

---

## 🔍 知识库检索算法

```
开始
  │
  ▼
┌─────────────────┐
│ 用户问题输入     │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 问题预处理       │
│ 关键词提取       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 知识库扫描       │
│ 遍历用户文献     │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 语义匹配算法     │
│ 相似度计算       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 内容截取         │
│ 限制2000字符     │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 构建提示词       │
│ 文献+问题        │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 返回相关文献     │
│ 内容片段         │
└─────────────────┘
```

---

## 🎨 前端渲染流程

```
开始
  │
  ▼
┌─────────────────┐
│ 接收AI回答       │
│ JSON格式        │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ renderAIContent │
│ 内容预处理       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ Markdown解析     │
│ • 代码块 ```    │
│ • 列表 -        │
│ • 标题 ##       │
│ • 图片 ![]()    │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ HTML标签生成     │
│ 结构化内容       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ typeWriterEffect │
│ 打字机效果       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 实时渲染显示     │
│ 逐字符输出       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 样式应用         │
│ CSS美化         │
└─────────────────┘
```

---

## 🔄 系统交互时序图

```
用户    前端      后端      知识库    AI模型
 │       │        │        │        │
 │──────►│        │        │        │  1. 登录请求
 │       │───────►│        │        │
 │       │◄───────│        │        │  2. 返回Token
 │       │        │        │        │
 │──────►│        │        │        │  3. 上传PDF
 │       │───────►│        │        │
 │       │        │───────►│        │  4. 保存到知识库
 │       │        │◄───────│        │
 │       │◄───────│        │        │  5. 返回处理结果
 │       │        │        │        │
 │──────►│        │        │        │  6. 提问
 │       │───────►│        │        │
 │       │        │───────►│        │  7. 检索知识库
 │       │        │◄───────│        │
 │       │        │───────────────►│  8. 调用AI模型
 │       │        │◄───────────────│
 │       │◄───────│        │        │  9. 返回回答
 │       │        │        │        │
 │◄──────│        │        │        │  10. 渲染显示
```

---

## 🛡️ 安全认证中间件流程

```
请求到达
  │
  ▼
┌─────────────────┐
│ authenticateToken│
│ 中间件检查       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 提取Token        │
│ Authorization   │
│ 或 query.token  │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ Token存在检查    │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ JWT验证          │
│ jwt.verify()    │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 验证成功？       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 设置req.user    │
│ 继续处理请求     │
└─────────────────┘
```

---

## 📊 数据流架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户数据       │    │   知识库数据     │    │   AI模型数据     │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • 用户信息       │    │ • PDF文档       │    │ • 问答记录       │
│ • 认证Token     │    │ • 文本内容       │    │ • 引用文献       │
│ • 会话状态       │    │ • 元数据        │    │ • 分析结果       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    Express.js 服务器                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 认证中间件   │  │ 路由处理     │  │ 服务层      │         │
│  │ JWT验证     │  │ API接口     │  │ AI调用      │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MongoDB       │    │   文件系统      │    │   阿里云API     │
│   用户存储       │    │   知识库存储     │    │   通义千问      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## 🎯 关键算法说明

### 1. **JWT认证算法**
- 使用 `jsonwebtoken` 库
- 密钥：`process.env.JWT_SECRET`
- 过期时间：24小时
- 算法：HS256

### 2. **密码加密算法**
- 使用 `bcryptjs` 库
- 盐值轮数：10
- 哈希算法：bcrypt

### 3. **PDF文本提取算法**
- 使用 `pdfjs-dist` 库
- 逐页解析PDF文档
- 提取文本内容并拼接

### 4. **知识库检索算法**
- 基于文件系统的简单检索
- 内容截取限制：2000字符
- 支持多文献内容合并

### 5. **多模型融合算法**
- 深度思考模型：问题分析
- 主回答模型：基于知识库回答
- 代码生成模型：代码相关问题

### 6. **前端渲染算法**
- Markdown轻量解析
- 打字机效果实现
- 实时HTML标签处理

---

## 🚀 性能优化策略

1. **文件上传优化**
   - 支持多文件并发上传
   - 文件类型预验证
   - 异步处理机制

2. **AI调用优化**
   - 多模型并行调用
   - 错误容错机制
   - 响应缓存策略

3. **前端渲染优化**
   - 流式响应展示
   - 内容分块渲染
   - 样式预加载

4. **知识库优化**
   - 内容长度限制
   - 文件系统缓存
   - 增量更新机制

---

这个流程图展示了 AI_WEB 项目的完整技术架构和核心算法流程，涵盖了用户认证、文档处理、AI问答、知识库管理等关键功能模块。
